<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.whythem.shop.product.mapper.ProductMapper">
    <select id="getProductList" resultType="ProductVO">
        SELECT
        PRODUCT_ID as productId,
        CATEGORY_ID as categoryId,
        NAME,
        PRICE,
        STOCK_QUANTITY as stockQuantity,
        DESCRIPTION,
        BRAND_NAME as brandName,
        IMAGE_URL as imageUrl
        FROM CBI_PRODUCT
        <where>
            <if test="categoryId != null">
                AND CATEGORY_ID = #{categoryId}
            </if>
        </where>
        ORDER BY PRODUCT_ID DESC
    </select>

    <insert id="insertProduct" parameterType="ProductVO">
        <selectKey keyProperty="productId" resultType="long" order="BEFORE">
            SELECT "SCOTT"."ISEQ$$_78145".nextval FROM DUAL
        </selectKey>

        INSERT INTO CBI_PRODUCT (
        PRODUCT_ID, CATEGORY_ID, NAME, PRICE, STOCK_QUANTITY,
        DESCRIPTION, BRAND_NAME, IMAGE_URL, STATUS
        ) VALUES (
        #{productId}, #{categoryId}, #{name}, #{price}, #{stockQuantity},
        #{description, jdbcType=CLOB}, #{brandName, jdbcType=VARCHAR},
        #{imageUrl, jdbcType=VARCHAR}, 'FOR_SALE'
        )
    </insert>

    <insert id="insertProductImage">
        INSERT INTO CBI_PRODUCT_IMAGE (
        IMAGE_ID,
        PRODUCT_ID,
        IMAGE_URL,
        IS_MAIN
        ) VALUES (
        "SCOTT"."ISEQ$$_78150".nextval, -- 직접 적어주신 이미지 시퀀스
        #{productId},
        #{imageUrl},
        #{isMain, jdbcType=CHAR}
        )
    </insert>
    <select id="findById" resultType="ProductVO">
        SELECT * FROM CBI_PRODUCT WHERE PRODUCT_ID = #{productId}
    </select>

    <update id="updateProduct" parameterType="ProductVO">
        UPDATE CBI_PRODUCT
        SET CATEGORY_ID = #{categoryId},
        NAME = #{name},
        PRICE = #{price},
        STOCK_QUANTITY = #{stockQuantity},
        DESCRIPTION = #{description, jdbcType=CLOB},
        BRAND_NAME = #{brandName, jdbcType=VARCHAR},
        IMAGE_URL = #{imageUrl, jdbcType=VARCHAR},
        UPDATED_AT = CURRENT_TIMESTAMP
        WHERE PRODUCT_ID = #{productId}
    </update>

    <delete id="deleteProductImages">
        DELETE FROM CBI_PRODUCT_IMAGE WHERE PRODUCT_ID = #{productId}
    </delete>

    <delete id="deleteProduct">
        DELETE FROM CBI_PRODUCT WHERE PRODUCT_ID = #{productId}
    </delete>

</mapper>